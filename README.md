# Telegram Alert Bot для билетных сайтов

Этот проект представляет собой скрипт на Python, предназначенный для мониторинга изменений на страницах билетных сайтов и отправки уведомлений в Telegram при определенных событиях (например, при появлении билетов или при изменении содержимого страницы).

## Описание

Скрипт выполняет следующие функции:

*   Периодически проверяет указанные URL-адреса на наличие текста "Билеты появятся позже".
*   Вычисляет SHA-256 хеш содержимого каждой страницы для обнаружения изменений.
*   Отправляет уведомления в Telegram при появлении билетов (отсутствии текста "Билеты появятся позже") или при изменении хеша страницы.
*   Отправляет ежедневные уведомления об отсутствии изменений.
*   Использует `systemd` для автоматического запуска и перезапуска в случае сбоев.
*   Загружает конфигурационные параметры (токен Telegram, ID чата, список URL) из файла `.env`.

## Необходимые компоненты

*   Python 3.6 или выше
*   Установленные библиотеки (см. раздел "Установка")
*   Настроенный Telegram-бот (см. раздел "Настройка")

## Установка

1.  **Клонируйте репозиторий:**

    ```bash
    git clone dnmos/bilet
    cd bilet/
    ```

2.  **Создайте виртуальное окружение (рекомендуется):**

    ```bash
    python3 -m venv env
    source env/bin/activate  # или env\Scripts\activate в Windows
    ```

3.  **Установите необходимые библиотеки:**

    ```bash
    pip3 install -r requirements.txt
    ```

    Если файла `requirements.txt` нет, создайте его, выполнив:
    ```bash
    pip3 install requests beautifulsoup4 python-telegram-bot schedule pytz python-dotenv
    pip3 freeze > requirements.txt
    ```

## Настройка

1.  **Создайте файл `.env`:**

    Создайте файл `.env` в корневой директории проекта и добавьте следующие переменные:

    ```
    TELEGRAM_BOT_TOKEN="YOUR_TELEGRAM_BOT_TOKEN"
    TELEGRAM_CHAT_ID="YOUR_TELEGRAM_CHAT_ID"
    URLS_TO_MONITOR='["https://", "https://example.com/another_url"]'
    ```

    *   `TELEGRAM_BOT_TOKEN`: Замените `YOUR_TELEGRAM_BOT_TOKEN` на токен вашего Telegram-бота (полученный от BotFather).
    *   `TELEGRAM_CHAT_ID`: Замените `YOUR_TELEGRAM_CHAT_ID` на ID вашего Telegram-чата, куда будут отправляться уведомления.
    *   `URLS_TO_MONITOR`: Замените список URL-адресов на те, которые вы хотите отслеживать.  **Важно:** URL-адреса должны быть заключены в квадратные скобки и двойные кавычки, как показано в примере.

    **Внимание:** Не храните конфиденциальную информацию (токен бота) непосредственно в коде. Файл `.env` должен быть добавлен в `.gitignore`, чтобы избежать его попадания в публичный репозиторий.

2.  **Настройте файл сервиса `systemd`:**

    *   Создайте файл сервиса `alertbot.service` в каталоге `/etc/systemd/system/`:

        ```bash
        sudo nano /etc/systemd/system/alertbot.service
        ```

    *   Вставьте следующее содержимое в файл (замените `/path/to/your/script.py`, `user`, `group` на ваши реальные значения):

        ```
        [Unit]
        Description=Telegram Alert Bot
        After=network.target

        [Service]
        User=your_user  # Замените на имя вашего пользователя
        Group=your_group # Замените на имя вашей группы
        WorkingDirectory=/path/to/your/script/directory # Замените на путь к директории скрипта
        ExecStart=/usr/bin/python3 /path/to/your/script/alertbot.py # Замените на путь к Python и скрипту
        Restart=on-failure
        RestartSec=10

        [Install]
        WantedBy=multi-user.target
        ```

        **Важные замены:**
        *   `User=your_user`:  Имя пользователя, от имени которого будет запущен скрипт, например `www`.
        *   `Group=your_group`:  Имя группы пользователя, например `www-data`.
        *   `WorkingDirectory`:  Рабочий каталог скрипта, например `home/www/bilet`.
        *   `ExecStart`:  Команда для запуска скрипта, например `/home/www/bilet/env/bin/python -m alertbot`.

**3. Включите и запустите сервис `systemd`:**

1.  Перезагрузите `systemd`, чтобы он прочитал новый файл сервиса:

    ```bash
    sudo systemctl daemon-reload
    ```

2.  Включите автоматический запуск сервиса при загрузке системы:

    ```bash
    sudo systemctl enable alertbot.service
    ```

3.  Запустите сервис немедленно:

    ```bash
    sudo systemctl start alertbot.service
    ```

## Использование

После выполнения настройки скрипт будет автоматически запускаться при загрузке системы и перезапускаться в случае сбоев. Он будет периодически проверять указанные URL-адреса и отправлять уведомления в Telegram.

## Проверка статуса сервиса

Чтобы убедиться, что сервис работает правильно, используйте команду:

```bash
sudo systemctl status alertbot.service
```

## Просмотр логов

Для отслеживания работы скрипта и выявления возможных ошибок используются логи. Вы можете просматривать логи следующими способами:

**1. Использование `journalctl` (рекомендуемый способ):**

`journalctl` — это стандартный инструмент для просмотра системных логов в Linux системах, использующих `systemd`.

*   **Просмотр логов только для вашего сервиса (`alertbot.service`):**

    ```bash
    sudo journalctl -u alertbot.service
    ```

    Эта команда покажет все логи, связанные только с вашим сервисом `alertbot.service`. Это самый удобный способ, так как вы не будете видеть логи других сервисов.

*   **Просмотр логов в реальном времени (слежение):**

    ```bash
    sudo journalctl -f -u alertbot.service
    ```

    Опция `-f` ("follow") позволяет просматривать логи в реальном времени, по мере их добавления. Это очень удобно для отладки или мониторинга работы скрипта. Чтобы остановить слежение за логами, нажмите `Ctrl+C`.

*   **Просмотр логов за определенный период времени:**

    *   За сегодня:

        ```bash
        sudo journalctl -u alertbot.service --since today
        ```

    *   За вчера:

        ```bash
        sudo journalctl -u alertbot.service --since yesterday --until today
        ```

    *   За последние X минут:

        ```bash
        sudo journalctl -u alertbot.service --since "X minutes ago"
        ```

*   **Фильтрация по уровню важности (severity):**

    Вы можете фильтровать логи по уровню важности, чтобы видеть только ошибки, предупреждения и т.д. Уровни важности: `emerg`, `alert`, `crit`, `err`, `warning`, `notice`, `info`, `debug`.

    *   Показать только ошибки:

        ```bash
        sudo journalctl -p err -u alertbot.service
        ```

    *   Показать предупреждения и ошибки:

        ```bash
        sudo journalctl -p warning -u alertbot.service
        ```

**2. Прямой просмотр файла лога (если вы настроили логирование в файл):**

Если вы перенаправляете вывод скрипта в файл (например, с помощью `>> /path/to/your/script.log 2>&1` в файле `cron` или `systemd`):

*   **Просмотр содержимого файла:**

    ```bash
    cat /path/to/your/script.log
    ```

*   **Просмотр файла в реальном времени:**

    ```bash
    tail -f /path/to/your/script.log
    ```

    Эта команда показывает последние строки файла и обновляет вывод по мере добавления новых данных. Чтобы остановить слежение, нажмите `Ctrl+C`.

## Дополнительная настройка

*   **`CHECK_INTERVAL_SECONDS`:** Вы можете изменить интервал между проверками страниц (в секундах), изменив значение переменной `CHECK_INTERVAL_SECONDS` в файле `.env` или непосредственно в коде скрипта.
*   **`NO_CHANGE_NOTIFICATION_TIMES`:** Вы можете изменить время отправки уведомлений об отсутствии изменений, изменив список `NO_CHANGE_NOTIFICATION_TIMES` в коде скрипта. Формат времени - `"HH:MM"` (например, `"08:00"`, `"20:00"`).

